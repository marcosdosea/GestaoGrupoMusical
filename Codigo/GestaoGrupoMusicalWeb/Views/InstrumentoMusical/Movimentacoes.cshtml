@using System.Linq
@model Core.DTO.InstrumentoAssociadoDTO.MovimentacoesAssociado
@inject Core.Service.IInformativoService informativoService
@{
    Layout = "_LayoutAssociado";
    ViewData["Title"] = "Movimentação de Instrumentos";
    var temEmprestimoPendente = Model.Emprestimos?.Any(e => e.NomeStatus == "Aguardando Confirmação") ?? false;
    var temDevolucaoPendente = Model.Devolucoes?.Any(d => d.NomeStatus == "Aguardando Confirmação") ?? false;
    var idFormConfirmar = "";

    if (temEmprestimoPendente)
    {
        var emprestimoConfirmar = Model.Emprestimos?.FirstOrDefault(e => e.NomeStatus == "Aguardando Confirmação");
        if (emprestimoConfirmar != null)
        {
            idFormConfirmar = emprestimoConfirmar.Id + "_confirmar";
        }
    }
    else if (temDevolucaoPendente)
    {
        var devolucaoConfirmar = Model.Devolucoes?.FirstOrDefault(d => d.NomeStatus == "Aguardando Confirmação");
        if (devolucaoConfirmar != null)
        {
            idFormConfirmar = devolucaoConfirmar.Id + "_confirmar";
        }
    }

    // Busca os 5 últimos informativos do grupo (sem alterar DTOs/controller)
    int idGrupoMusical = 0;
    int.TryParse(User.FindFirst("IdGrupoMusical")?.Value, out idGrupoMusical);
    var informativos = Enumerable.Empty<Core.Informativo>();
    if (idGrupoMusical > 0)
    {
        informativos = informativoService
            .GetAllInformativoServicePorIdGrupoMusical(idGrupoMusical)
            .OrderByDescending(i => i.Data)
            .Take(5);
    }
}

<partial name="_Notificar" />

<h5 class="mb-3">Últimos Informativos</h5>

<div class="table-responsive">
    <table class="table mt-3">
        <thead>
            <tr class="bg-danger bg-opacity-75 text-white">
                <th class="col-md-3">Data</th>
                <th class="col-md-9">Mensagem</th>
            </tr>
        </thead>
        <tbody>
            @if (informativos != null && informativos.Any())
            {
                foreach (var info in informativos)
                {
                    <tr class="border-bottom border-danger border-opacity-75 align-middle">
                        <td class="py-3">@info.Data.ToString("dd/MM/yyyy")</td>
                        <td class="py-3">@info.Mensagem</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="2" class="py-3 text-center">Nenhum informativo disponível.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal Bootstrap -->
<div class="modal fade" id="confirmacaoModal" tabindex="-1" aria-labelledby="confirmacaoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmacaoModalLabel">Confirmação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        @if (temEmprestimoPendente)
        {
            <span>Confirma o recebimento do instrumento?</span>
        }
        else if (temDevolucaoPendente)
        {
            <span>Confirma devolução do instrumento?</span>
        }
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" id="btnConfirmar">Confirmar</button>
        <button type="button" class="btn btn-danger" id="btnRecusar" data-bs-dismiss="modal">Recusar</button>
      </div>
    </div>
  </div>
</div>

<h1 class="fs-5 my-3">@Html.DisplayNameFor(m => m.Emprestimos)</h1>
<partial name="_TabelaEmprestimosAssociado" model="Model.Emprestimos" />

<h1 class="fs-5 my-3">@Html.DisplayNameFor(m => m.Devolucoes)</h1>
<partial name="_TabelaDevolucoesAssociado" model="Model.Devolucoes" />

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var temEmprestimoPendente = @temEmprestimoPendente.ToString().ToLower();
            var temDevolucaoPendente = @temDevolucaoPendente.ToString().ToLower();
            var idFormConfirmar = '@idFormConfirmar';

            if (temEmprestimoPendente || temDevolucaoPendente) {
                var modal = new bootstrap.Modal(document.getElementById('confirmacaoModal'));
                modal.show();
            }

            var btnConfirm = document.getElementById('btnConfirmar');
            if (btnConfirm) {
                btnConfirm.addEventListener('click', function () {
                    var form = document.getElementById(idFormConfirmar);
                    if (form) {
                        form.submit();
                    } else {
                        console.error('Form not found: ' + idFormConfirmar);
                        alert('O formulário de confirmação não foi encontrado. Por favor, tente novamente ou entre em contato com o suporte.');
                    }
                });
            }
        });
    </script>
}